{
    auto_https off  # Disable automatic HTTPS since Cloudflare manages it
    admin off
    log {
        output file /var/log/caddy_debug.log
        format json
        level debug  # Enhanced debugging level for detailed logs
    }
}

# Redirect HTTP to HTTPS, except for ACME challenge
http://mindlink.cc, http://app.mindlink.cc {
    route /.well-known/acme-challenge/* {
        root * /var/www/acme-challenges
        file_server
    }

    redir https://{host}{uri} permanent  # Redirect all other traffic to HTTPS
}

# HTTPS configurations
https://mindlink.cc, https://app.mindlink.cc {
    # Define reusable security headers
    @secure_headers {
        Strict-Transport-Security "max-age=63072000; includeSubDomains; preload"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "DENY"
        Referrer-Policy "no-referrer-when-downgrade"
        Content-Security-Policy "default-src 'self'"
        Permissions-Policy "geolocation=(), microphone=(), camera=()"
        X-XSS-Protection "1; mode=block"
        X-Forwarded-Proto "https"  # Force HTTPS in the header
        X-Forwarded-For {remote_host}
        Host {host}
    }

    # Apply security headers
    header @secure_headers

    # ACME challenge handling for HTTPS
    handle /.well-known/acme-challenge/* {
        root * /var/www/acme-challenges
        file_server
    }

    # AWSBotService routing
    handle /s3* {
        reverse_proxy https://awsbotservice.railway.internal:443 {
            header_up X-Forwarded-Proto "https"
            transport http {
                tls_insecure_skip_verify  # Use with caution in production
            }
        }
    }

    # Skills Management Service routing
    handle /skills* {
        reverse_proxy https://sithskillsservice-finalproduction.up.railway.app {
            header_up Host "sithskillsservice-finalproduction.up.railway.app"
            header_up X-Forwarded-Proto "https"
            transport http {
                tls_insecure_skip_verify  # Use trusted certs in production
            }
        }
    }

    # SithBotModeManagerService routing
    handle /mode* {
        reverse_proxy https://sithbotmodemanagerservice-finalproduction.up.railway.app {
            header_up Host "sithbotmodemanagerservice-finalproduction.up.railway.app"
            header_up X-Forwarded-Proto "https"
            transport http {
                tls_insecure_skip_verify  # Use secure certs in production
            }
        }
    }

    # SithPythonServices routing
    handle /memory* {
        reverse_proxy https://sithpythonservices.railway.internal:443 {
            header_up Host "sithpythonservices.railway.internal"
            header_up X-Forwarded-Proto "https"
            transport http {
                tls_insecure_skip_verify  # Replace with valid certs in production
            }
        }
    }

    # Static file serving
    handle {
        root * /var/www/html
        file_server
    }

    # Error handling
    handle_errors {
        rewrite * /error.html
        file_server
    }
}
